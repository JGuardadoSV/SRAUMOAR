@page
@inject IJsonHelper Json
@model SRAUMOAR.Pages.aranceles.FacturasModel

@{
    ViewData["Title"] = "Cobros realizados";
}

<style>
    :root {
        --primary-color: #166913;
        --primary-light: #1e7a1a;
        --primary-dark: #0f4a0d;
        --success-light: #d4edda;
        --border-radius: 12px;
        --shadow-sm: 0 2px 4px rgba(22, 105, 19, 0.1);
        --shadow-md: 0 4px 12px rgba(22, 105, 19, 0.15);
        --shadow-lg: 0 8px 24px rgba(22, 105, 19, 0.2);
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: skewX(-15deg);
            transform-origin: top;
        }

        .page-header h1 {
            color: white;
            font-weight: 600;
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

    .main-card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        background: white;
    }

    .table-container {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .custom-table {
        margin: 0;
        font-size: 0.95rem;
    }

        .custom-table thead th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            border: none;
            position: relative;
        }

        .custom-table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e9ecef;
        }

            .custom-table tbody tr:hover {
                background-color: rgba(22, 105, 19, 0.05);
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(22, 105, 19, 0.1);
            }

        .custom-table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-top: none;
        }

        .custom-table .alumno-column {
            width: 20%;
            max-width: 200px;
        }

            .custom-table .alumno-column .student-name {
                font-size: 0.9rem;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        .custom-table .actions-column {
            width: 180px;
            min-width: 180px;
        }

    .amount-cell {
        font-weight: 600;
        color: var(--primary-color);
        font-family: 'Courier New', monospace;
    }

    .action-btn {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #138496 0%, #0f6674 100%);
        }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        max-width: 450px;
        margin: auto;
    }

    .modal-header {
        background: var(--primary-color);
        color: white;
        border-bottom: none;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        padding: 1.5rem 2rem;
    }

    .modal-title {
        font-weight: 600;
        font-size: 1.3rem;
    }

    .btn-close {
        filter: invert(1);
        opacity: 0.8;
    }

        .btn-close:hover {
            opacity: 1;
        }

    .ticket-container {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.6;
        background: #fafafa;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .ticket-header {
        text-align: center;
        border-bottom: 2px dashed #ccc;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

        .ticket-header h6 {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

    .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.2rem 0;
    }

    .detail-label {
        font-weight: bold;
        color: var(--primary-dark);
    }

    .detail-value {
        color: #333;
    }

    .amount-highlight {
        color: var(--primary-color);
        font-weight: bold;
    }

    .ticket-footer {
        text-align: center;
        border-top: 2px dashed #ccc;
        padding-top: 1rem;
        margin-top: 1rem;
        color: #666;
    }

    .aranceles-table {
        margin: 1rem 0;
        font-size: 0.85rem;
    }

        .aranceles-table th {
            background: var(--primary-dark);
            color: white;
            padding: 0.5rem;
            font-weight: 600;
        }

        .aranceles-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #ddd;
        }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .page-header {
            padding: 1.5rem 1rem;
        }

            .page-header h1 {
                font-size: 1.8rem;
            }

        .custom-table {
            font-size: 0.85rem;
        }

            .custom-table thead th,
            .custom-table tbody td {
                padding: 0.75rem 0.5rem;
            }
    }

    /* Print Styles */
    @@media print {
        .modal-header,
        .modal-footer {
            display: none !important;
        }

        .modal-content {
            box-shadow: none;
        }

        .ticket-container {
            background: white;
        }
    }
</style>

<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Cobros Realizados</h1>
        <p class="mb-0 text-white-50">Gestión y seguimiento de pagos de aranceles</p>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-12">
            <div class="main-card card">
                <div class="card-body p-0">
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="custom-table table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>@Html.DisplayNameFor(model => model.CobroArancel[0].Fecha)</th>
                                        <th class="alumno-column">@Html.DisplayNameFor(model => model.CobroArancel[0].Alumno)</th>
                                        <th>@Html.DisplayNameFor(model => model.CobroArancel[0].Ciclo)</th>
                                        <th>Monto</th>
                                        <th>Efectivo Recibido</th>
                                        <th>@Html.DisplayNameFor(model => model.CobroArancel[0].Cambio)</th>
                                        <th class="actions-column">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   
                                        @foreach (var item in Model.CobroArancel)
                                        {
                                            <tr>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.Fecha)
                                                </td>
                                                <td class="alumno-column">
                                                    <div class="d-flex align-items-center">
                                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-white me-2 flex-shrink-0" style="width: 28px; height: 28px; font-size: 0.75rem;">
                                                            @if (item.Alumno?.Nombres != null && item.Alumno?.Apellidos != null)
                                                            {
                                                                @(item.Alumno.Nombres.Substring(0, 1) + item.Alumno.Apellidos.Substring(0, 1))
                                                            }
                                                        </div>
                                                        <div class="student-name" title="@Html.DisplayFor(modelItem => item.Alumno.Nombres) @Html.DisplayFor(modelItem => item.Alumno.Apellidos)">
                                                            <strong>@Html.DisplayFor(modelItem => item.Alumno.Nombres) @Html.DisplayFor(modelItem => item.Alumno.Apellidos)</strong>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        @Html.DisplayFor(modelItem => item.Ciclo.NCiclo)/@Html.DisplayFor(modelItem => item.Ciclo.anio)
                                                    </span>
                                                </td>
                                                <td class="amount-cell">$@Html.DisplayFor(modelItem => item.Total)</td>
                                                <td class="amount-cell">$@Html.DisplayFor(modelItem => item.EfectivoRecibido)</td>
                                                <td class="amount-cell">$@Html.DisplayFor(modelItem => item.Cambio)</td>
                                                <td class="actions-column">
                                                    <div class="d-flex gap-1 flex-wrap">
                                                        <button class="btn btn-outline-danger btn-sm" onclick="verPDF(@item.CobroArancelId)" title="Ver PDF">
                                                            PDF
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalles -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">
                    Ticket de Cobro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="ticket-container">
                    <!-- Encabezado del Ticket -->
                    <div class="ticket-header">
                        <h6>Universidad Monseñor Oscar Arnulfo Romero</h6>
                        <small>Dirección: Calle Principal, Ciudad</small><br>
                        <small>Teléfono: 1234-5678</small>
                    </div>

                    <!-- Detalles del Cobro -->
                    <div id="cobroDetails">
                        <div class="detail-row">
                            <span class="detail-label">Fecha:</span>
                            <span class="detail-value" id="detalleFecha"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ciclo:</span>
                            <span class="detail-value" id="detalleCiclo"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Alumno:</span>
                            <span class="detail-value" id="detalleAlumno"></span>
                        </div>

                        <div style="margin: 1rem 0;">
                            <div class="detail-label" style="margin-bottom: 0.5rem;">Aranceles:</div>
                            <div id="detalleArancel"></div>
                        </div>

                        <div class="detail-row" style="border-top: 1px dashed #ccc; padding-top: 0.5rem; margin-top: 1rem;">
                            <span class="detail-label">Total:</span>
                            <span class="detail-value amount-highlight">$<span id="detalleCosto"></span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Efectivo Recibido:</span>
                            <span class="detail-value amount-highlight">$<span id="detalleEfectivoRecibido"></span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Cambio:</span>
                            <span class="detail-value amount-highlight">$<span id="detalleCambio"></span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Nota:</span>
                            <span class="detail-value" id="detalleNota"></span>
                        </div>
                    </div>

                    <!-- Mensaje Final -->
                    <div class="ticket-footer">
                        <small>¡Gracias por su preferencia!</small><br>
                        <small>Este documento no es válido como factura.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-print-none">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cerrar
                </button>
                <button type="button" class="btn btn-success" onclick="window.print();" style="background-color: var(--primary-color); border-color: var(--primary-color);">
                    Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function showDetails(id) {
            $.ajax({
                url: '@Url.Page("DetallesCobro")',
                type: 'GET',
                data: { id: id },
                success: function (data) {
                    console.log('Datos recibidos:', data);
                    $('#detalleFecha').text(data.fecha);
                    $('#detalleCiclo').text(data.ciclo);
                    $('#detalleAlumno').text(data.alumno);
                    $('#detalleCosto').text(data.costoTotal);
                    $('#detalleEfectivoRecibido').text(data.efectivoRecibido);
                    $('#detalleCambio').text(data.cambio);
                    $('#detalleNota').text(data.nota);

                    // Construir tabla de detalles de aranceles
                    let arancelesTable = '<table class="aranceles-table table table-sm">';
                    arancelesTable += '<thead><tr><th>Arancel</th><th>Costo</th></tr></thead>';
                    arancelesTable += '<tbody>';
                    data.arancelesDetalles.forEach(function(arancel) {
                        arancelesTable += '<tr>';
                        arancelesTable += `<td>${arancel.arancel}</td>`;
                        arancelesTable += `<td class="amount-highlight">${arancel.costo.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>`;
                        arancelesTable += '</tr>';
                    });
                    arancelesTable += '</tbody></table>';

                    // Insertar tabla en el contenedor correspondiente
                    $('#detalleArancel').html(arancelesTable);

                    $('#detailsModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar los detalles:', error);
                    alert('Error al cargar los detalles del cobro. Por favor, intente nuevamente.');
                }
            });
        }

        // Función para ver PDF (placeholder para tu implementación)
        function verPDF(id) {
            // Aquí puedes agregar tu lógica para el PDF
            // Por ejemplo: window.open('/tu-endpoint-pdf?id=' + id, '_blank');
            console.log('Ver PDF para cobro ID:', id);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('detailsModal');

            // Remove the inert attribute when the modal is shown
            modal.addEventListener('show.bs.modal', () => {
                modal.removeAttribute('inert');
            });

            // Add the inert attribute when the modal is hidden
            modal.addEventListener('hide.bs.modal', () => {
                modal.setAttribute('inert', '');
            });

            // Add smooth scrolling and enhanced interactions
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px) scale(1.05)';
                });
                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>
}
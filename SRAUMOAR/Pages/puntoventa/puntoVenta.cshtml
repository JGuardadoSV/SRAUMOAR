@page "/puntoventa/puntoVenta"

@model SRAUMOAR.Pages.puntoventa.puntoVentaModel
@{
    ViewData["Title"] = "Facturación";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Facturación</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Inicio</a></li>
                    <li class="breadcrumb-item active">Facturación</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <form method="post">
            <!-- Tipo de Documento - Barra compacta -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card card-warning card-outline">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <label class="mb-0"><strong>Tipo de Documento:</strong></label>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-control" asp-for="Factura.TipoDocumento" id="tipoDocumentoSelect">
                                        <option value="">Seleccione...</option>
                                        <option value="01">01 - Consumidor Final</option>
                                        <option value="02">02 - Crédito Fiscal</option>
                                        <option value="14">11 - Sujeto Excluido</option>
                                        <option value="15">15 - Donación</option>
                                    </select>
                                    <small class="text-muted">* Seleccione el tipo de documento antes de agregar productos. El IVA solo se aplica para Crédito Fiscal.</small>
                                </div>
                                <div class="col-md-3">
                                    <span asp-validation-for="Factura.TipoDocumento" class="text-danger"></span>
                                </div>
                            </div>
                            
                            <!-- Mensaje de alerta cuando no hay tipo seleccionado -->
                            <div class="row mt-2" id="alertaTipoDocumento" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>¡Atención!</strong> Debe seleccionar un tipo de documento antes de continuar con la facturación.
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campo de País (solo para Donación) -->
                            <div class="row mt-2 campo-pais" style="display: none;">
                                <div class="col-md-3">
                                    <label class="mb-0"><strong>Código de País:</strong></label>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-control" asp-for="Factura.CodigoPais">
                                        <option value="">Seleccione país...</option>
                                        <optgroup label="Centro América">
                                            <option value="BZ">BZ - Belice</option>
                                            <option value="CR">CR - Costa Rica</option>
                                            <option value="SV">SV - El Salvador</option>
                                            <option value="GT">GT - Guatemala</option>
                                            <option value="HN">HN - Honduras</option>
                                            <option value="NI">NI - Nicaragua</option>
                                            <option value="PA">PA - Panamá</option>
                                        </optgroup>
                                        <optgroup label="Norte América">
                                            <option value="CA">CA - Canadá</option>
                                            <option value="US">US - Estados Unidos</option>
                                            <option value="MX">MX - México</option>
                                        </optgroup>
                                        <optgroup label="Europa">
                                            <option value="ES">ES - España</option>
                                        </optgroup>
                                    </select>
                                    <small class="text-muted">* Requerido para documentos de donación</small>
                                </div>
                                <div class="col-md-3">
                                    <span asp-validation-for="Factura.CodigoPais" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Campos para Sujeto Excluido (Bien/Servicio y Retención) -->
                            <div class="row mt-2 campo-sujeto-excluido" style="display: none;">
                                <div class="col-md-3">
                                    <label class="mb-0"><strong>Tipo de Operación:</strong></label>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-control" asp-for="Factura.TipoOperacion" id="tipoOperacionSelect">
                                        <option value="">Seleccione...</option>
                                        <option value="Bien">Bien</option>
                                        <option value="Servicio">Servicio</option>
                                    </select>
                                    <small class="text-muted">* Indique si el pago es por un bien o un servicio.</small>
                                </div>
                            </div>
                            <div class="row mt-2 campo-sujeto-excluido" style="display: none;">
                                <div class="col-md-3">
                                    <label class="mb-0"><strong>Retención de Renta (10%):</strong></label>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" asp-for="Factura.Retencion" id="retencionRentaCheck" />
                                        <label class="form-check-label" for="retencionRentaCheck">Aplicar retención de renta</label>
                                    </div>
                                    <small class="text-muted">* Si se activa, se retendrá el 10% del monto total.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Datos del Emisor -->
                <div class="col-md-6">
                    <div class="card card-primary">
                        <div class="card-header" data-toggle="collapse" data-target="#datosEmisor" style="cursor: pointer;">
                            <h3 class="card-title">
                                <i class="fas fa-building"></i> Datos del Emisor
                                <i class="fas fa-chevron-down float-right"></i>
                            </h3>
                        </div>
                        <div class="collapse show" id="datosEmisor">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>NIT</label>
                                            <input type="text" class="form-control" asp-for="Factura.Emisor.Nit" readonly />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>NRC</label>
                                            <input type="text" class="form-control" asp-for="Factura.Emisor.Nrc" readonly />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" class="form-control" asp-for="Factura.Emisor.Nombre" readonly />
                                </div>
                                <div class="form-group">
                                    <label>Nombre Comercial</label>
                                    <input type="text" class="form-control" asp-for="Factura.Emisor.NombreComercial" readonly />
                                </div>
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <input type="text" class="form-control" asp-for="Factura.Emisor.Direccion.Complemento" readonly />
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Teléfono</label>
                                            <input type="text" class="form-control" asp-for="Factura.Emisor.Telefono" readonly />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Correo</label>
                                            <input type="email" class="form-control" asp-for="Factura.Emisor.Correo" readonly />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datos del Receptor -->
                <div class="col-md-6">
                    <div class="card card-info">
                        <div class="card-header" data-toggle="collapse" data-target="#datosReceptor" style="cursor: pointer;">
                            <h3 class="card-title">
                                <i class="fas fa-user"></i> Datos del Receptor
                                <i class="fas fa-chevron-down float-right"></i>
                            </h3>
                        </div>
                        <div class="collapse show" id="datosReceptor">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>NIT</label>
                                            <input type="text" class="form-control" asp-for="Factura.Receptor.Nit" />
                                        </div>
                                    </div>
                                    <div class="col-md-6 campos-credito-fiscal" style="display: none;">
                                        <div class="form-group">
                                            <label>NRC</label>
                                            <input type="text" class="form-control" asp-for="Factura.Receptor.Nrc" />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" class="form-control" asp-for="Factura.Receptor.Nombre" />
                                </div>
                                <div class="form-group">
                                    <label>Nombre Comercial</label>
                                    <input type="text" class="form-control" asp-for="Factura.Receptor.NombreComercial" />
                                </div>
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <input type="text" class="form-control" asp-for="Factura.Receptor.Direccion.Complemento" />
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Departamento</label>
                                            <select class="form-control" asp-for="Factura.Receptor.CodigoDepartamento">
                                                <option value="">Seleccione...</option>
                                                <option value="00">00 - Otro (Para extranjeros)</option>
                                                <option value="01">01 - Ahuachapán</option>
                                                <option value="02">02 - Santa Ana</option>
                                                <option value="03">03 - Sonsonate</option>
                                                <option value="04">04 - Chalatenango</option>
                                                <option value="05">05 - La Libertad</option>
                                                <option value="06">06 - San Salvador</option>
                                                <option value="07">07 - Cuscatlán</option>
                                                <option value="08">08 - La Paz</option>
                                                <option value="09">09 - Cabañas</option>
                                                <option value="10">10 - San Vicente</option>
                                                <option value="11">11 - Usulután</option>
                                                <option value="12">12 - San Miguel</option>
                                                <option value="13">13 - Morazán</option>
                                                <option value="14">14 - La Unión</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Municipio</label>
                                            <select class="form-control" asp-for="Factura.Receptor.CodigoMunicipio">
                                                <option value="">Seleccione departamento primero...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Teléfono</label>
                                            <input type="text" class="form-control" asp-for="Factura.Receptor.Telefono" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label>Correo</label>
                                            <input type="email" class="form-control" asp-for="Factura.Receptor.Correo" />
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Campos adicionales para Crédito Fiscal -->
                                <div class="campos-credito-fiscal" style="display: none;">
                                    <hr class="my-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Giro</label>
                                                <input type="text" class="form-control" asp-for="Factura.Receptor.DescActividad" placeholder="Ingrese el giro del receptor" />
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>Código de Actividad Económica</label>
                                                <input type="text" class="form-control" asp-for="Factura.Receptor.CodActividad" placeholder="Ej: 85499" />
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <button type="button" class="btn btn-info btn-block" onclick="abrirClasificacionBCR()" title="Buscar en clasificación BCR">
                                                    <i class="fas fa-search"></i> BUSCAR
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        Estos campos son requeridos únicamente para documentos de Crédito Fiscal. 
                                        Haga clic en el botón de búsqueda para consultar la clasificación oficial del BCR.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Productos -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">Agregar Producto</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Código</label>
                                        <input type="text" class="form-control" asp-for="Factura.CodigoProducto" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Descripción</label>
                                        <input type="text" class="form-control" asp-for="Factura.DescripcionProducto" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="Factura.CantidadProducto" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Precio Unit.</label>
                                        <input type="number" step="0.01" class="form-control" asp-for="Factura.PrecioProducto" />
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label>Exento</label>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" asp-for="Factura.ProductoExento" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button type="submit" asp-page-handler="AgregarProducto" class="btn btn-secondary btn-block btn-agregar-producto" disabled>
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Productos -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Productos Agregados</h3>
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-hover text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Descripción</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unit.</th>
                                        <th>Tipo</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Factura.Productos.Any())
                                    {
                                        @for (int i = 0; i < Model.Factura.Productos.Count; i++)
                                        {
                                            <tr>
                                                <td>@Model.Factura.Productos[i].Codigo</td>
                                                <td>@Model.Factura.Productos[i].Descripcion</td>
                                                <td>@Model.Factura.Productos[i].Cantidad.ToString("N2")</td>
                                                <td>$@Model.Factura.Productos[i].PrecioUnitario.ToString("N2")</td>
                                                <td>
                                                    <span class="badge @(Model.Factura.Productos[i].EsExento ? "badge-exento" : "badge-gravado")">
                                                        @(Model.Factura.Productos[i].EsExento ? "Exento" : "Gravado")
                                                    </span>
                                                </td>
                                                <td>$@Model.Factura.Productos[i].SubTotal.ToString("N2")</td>
                                                <td>
                                                    <button type="submit" asp-page-handler="EliminarProducto" asp-route-id="@Model.Factura.Productos[i].Id" 
                                                            class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash-alt"></i> Eliminar
                                                    </button>
                                                </td>
                                            </tr>
                                            <input type="hidden" asp-for="Factura.Productos[i].Id" />
                                            <input type="hidden" asp-for="Factura.Productos[i].Codigo" />
                                            <input type="hidden" asp-for="Factura.Productos[i].Descripcion" />
                                            <input type="hidden" asp-for="Factura.Productos[i].Cantidad" />
                                            <input type="hidden" asp-for="Factura.Productos[i].PrecioUnitario" />
                                            <input type="hidden" asp-for="Factura.Productos[i].EsExento" />
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">No hay productos agregados</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

@*             <!-- Debug de valores del modelo -->
            <div class="row">
                <div class="col-12">
                    <p>DEBUG: TipoDocumento: @Model.Factura.TipoDocumento</p>
                    <p>DEBUG: Retencion: @Model.Factura.Retencion</p>
                    <p>DEBUG: TotalGeneral: @Model.Factura.TotalGeneral</p>
                    <p>DEBUG: TotalGeneralConRetencion: @Model.Factura.TotalGeneralConRetencion</p>
                </div>
            </div> *@

            <!-- Totales -->
            @if (Model.Factura.Productos.Any())
            {
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <div class="card card-outline card-primary">
                            <div class="card-header">
                                <h3 class="card-title">Totales</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6"><strong>Subtotal Exento:</strong></div>
                                    <div class="col-6 text-right">$@Model.Factura.TotalExento.ToString("N2")</div>
                                </div>
                                <div class="row">
                                    <div class="col-6"><strong>Subtotal Gravado:</strong></div>
                                    <div class="col-6 text-right">$@Model.Factura.TotalGravado.ToString("N2")</div>
                                </div>
                                <div class="row iva-row">
                                    <div class="col-6"><strong>IVA (13%):</strong></div>
                                    <div class="col-6 text-right">$@Model.Factura.IVA.ToString("N2")</div>
                                </div>
                                @* Mostrar retención solo si es Sujeto Excluido y está activada *@
                                @if (Model.Factura.TipoDocumento == "14" && Model.Factura.Retencion == true)
                                {
                                    <div class="row">
                                        <div class="col-6"><strong>Retención de Renta (10%):</strong></div>
                                        <div class="col-6 text-right text-danger">-$@((Model.Factura.Productos.Sum(p => p.Cantidad * p.PrecioUnitario) * 0.10M).ToString("N2"))</div>
                                    </div>
                                }
                                <hr>
                                <div class="row">
                                    <div class="col-6"><strong>Total General:</strong></div>
                                    <div class="col-6 text-right"><strong>$@Model.Factura.TotalGeneralConRetencion.ToString("N2")</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón de Procesar -->
                <div class="row">
                    <div class="col-md-12 text-center">
                        <button type="submit" asp-page-handler="ProcesarFactura" class="btn btn-primary btn-lg">
                            <i class="fas fa-file-invoice-dollar"></i> Procesar Factura
                        </button>
                    </div>
                </div>
            }

            <!-- Hidden fields para mantener datos del emisor -->
            <input type="hidden" asp-for="Factura.Emisor.Nit" />
            <input type="hidden" asp-for="Factura.Emisor.Nrc" />
            <input type="hidden" asp-for="Factura.Emisor.Nombre" />
            <input type="hidden" asp-for="Factura.Emisor.NombreComercial" />
            <input type="hidden" asp-for="Factura.Emisor.Direccion.Complemento" />
            <input type="hidden" asp-for="Factura.Emisor.Telefono" />
            <input type="hidden" asp-for="Factura.Emisor.Correo" />
            <input type="hidden" asp-for="Factura.Receptor.CodigoDepartamento" />
            <input type="hidden" asp-for="Factura.Receptor.CodigoMunicipio" />
            <input type="hidden" asp-for="Factura.Receptor.CodActividad" />
            <input type="hidden" asp-for="Factura.Receptor.DescActividad" />
            <input type="hidden" asp-for="Factura.CodigoPais" />
        </form>
    </div>
</section>

@section Scripts {
    <script>
        // Auto-focus en el campo de código después de agregar producto
        $(document).ready(function() {
            $('#Factura_CodigoProducto').focus();
            
            // Guardar posición del scroll antes de enviar el formulario
            var scrollPosition = 0;
            
            // Seleccionar contenido al hacer clic en Cantidad y Precio Unitario
            $('#Factura_CantidadProducto, #Factura_PrecioProducto').on('click', function() {
                $(this).select();
            });
            
            // Capturar posición del scroll antes de enviar formulario
            $('form').on('submit', function() {
                scrollPosition = $(window).scrollTop();
                sessionStorage.setItem('scrollPosition', scrollPosition);
                
                // Guardar el municipio seleccionado antes de enviar
                var municipioSeleccionado = $('#Factura_Receptor_CodigoMunicipio').val();
                if (municipioSeleccionado) {
                    sessionStorage.setItem('municipioSeleccionado', municipioSeleccionado);
                }
            });
            
            // Restaurar posición del scroll después de cargar la página
            $(window).on('load', function() {
                var savedPosition = sessionStorage.getItem('scrollPosition');
                if (savedPosition) {
                    setTimeout(function() {
                        // Scroll suave a la posición guardada
                        $('html, body').animate({
                            scrollTop: savedPosition
                        }, 300);
                        sessionStorage.removeItem('scrollPosition');
                        
                        // Enfocar en el campo de código después de restaurar posición
                        $('#Factura_CodigoProducto').focus();
                    }, 100);
                }
            });
            
            // Restaurar municipio seleccionado si existe
            setTimeout(function() {
                restaurarMunicipioSeleccionado();
            }, 200);
            
            // Restaurar posición del scroll si existe
            var savedPosition = sessionStorage.getItem('scrollPosition');
            if (savedPosition) {
                setTimeout(function() {
                    // Scroll suave a la posición guardada
                    $('html, body').animate({
                        scrollTop: savedPosition
                    }, 300);
                    sessionStorage.removeItem('scrollPosition');
                    
                    // Enfocar en el campo de código después de restaurar posición
                    $('#Factura_CodigoProducto').focus();
                }, 100);
            }
            
            // Inicializar estado del IVA según el tipo de documento
            function actualizarEstado() {
                var tipoDoc = $('#tipoDocumentoSelect').val();
                var ivaRow = $('.iva-row');
                var btnAgregar = $('.btn-agregar-producto');
                var campoPais = $('.campo-pais');
                var camposCreditoFiscal = $('.campos-credito-fiscal');
                var alertaTipoDocumento = $('#alertaTipoDocumento');
                var campoSujetoExcluido = $('.campo-sujeto-excluido');
                
                console.log('Tipo documento:', tipoDoc); // Debug
                console.log('Botón encontrado:', btnAgregar.length); // Debug
                
                // Mostrar/ocultar alerta de tipo de documento
                if (!tipoDoc) {
                    alertaTipoDocumento.show();
                } else {
                    alertaTipoDocumento.hide();
                }
                
                if (tipoDoc === '02') {
                    // Mostrar IVA solo para Crédito Fiscal
                    ivaRow.show();
                    // Mostrar campos adicionales para Crédito Fiscal
                    camposCreditoFiscal.show();
                    recalcularTotales(true); // Con IVA
                } else {
                    // Ocultar IVA para todos los demás tipos de documento
                    ivaRow.hide();
                    // Ocultar campos adicionales para otros tipos
                    camposCreditoFiscal.hide();
                    recalcularTotales(false); // Sin IVA
                }
                
                // Mostrar/ocultar campo de país según tipo de documento
                if (tipoDoc === '15') {
                    // Mostrar campo de país solo para Donación
                    campoPais.show();
                } else {
                    // Ocultar campo de país para otros tipos
                    campoPais.hide();
                    $('#Factura_CodigoPais').val(''); // Limpiar valor
                }
                
                // Habilitar/deshabilitar botón de agregar según tipo de documento
                if (tipoDoc) {
                    btnAgregar.prop('disabled', false).removeClass('btn-secondary').addClass('btn-success');
                    console.log('Botón habilitado'); // Debug
                } else {
                    btnAgregar.prop('disabled', true).removeClass('btn-success').addClass('btn-secondary');
                    console.log('Botón deshabilitado'); // Debug
                }

                // Mostrar/ocultar campos para Sujeto Excluido
                if (tipoDoc === '14') {
                    campoSujetoExcluido.show();
                } else {
                    campoSujetoExcluido.hide();
                    $('#tipoOperacionSelect').val('');
                    $('#retencionRentaCheck').prop('checked', false);
                }
            }
            
            // Función para recalcular totales dinámicamente
            function recalcularTotales(conIVA) {
                var totalExento = 0;
                var totalGravado = 0;
                
                // Verificar si hay productos en la tabla
                var filasProductos = $('.table tbody tr').not(':contains("No hay productos")');
                
                if (filasProductos.length > 0) {
                    // Calcular subtotales desde la tabla de productos
                    filasProductos.each(function() {
                        var row = $(this);
                        var subtotalText = row.find('td:eq(5)').text(); // Columna del subtotal
                        var esExento = row.find('.badge').text().trim() === 'Exento';
                        
                        // Extraer el valor numérico del subtotal
                        var subtotal = parseFloat(subtotalText.replace('$', '').replace(',', '')) || 0;
                        
                        if (esExento) {
                            totalExento += subtotal;
                        } else {
                            totalGravado += subtotal;
                        }
                    });
                }
                
                // Calcular IVA si corresponde
                var iva = conIVA ? totalGravado * 0.13 : 0;
                var totalGeneral = totalExento + totalGravado + iva;
                
                // Actualizar los valores en la interfaz
                $('.card-body .row:eq(0) .col-6:last').text('$' + totalExento.toFixed(2));
                $('.card-body .row:eq(1) .col-6:last').text('$' + totalGravado.toFixed(2));
                $('.iva-row .col-6:last').text('$' + iva.toFixed(2));
                console.log('Totales recalculados:', { totalExento, totalGravado, iva, totalGeneral });
            }
            
            // Actualizar cálculos cuando cambie el tipo de documento
            $('#tipoDocumentoSelect').on('change', function() {
                console.log('Cambio detectado en tipo documento'); // Debug
                actualizarEstado();
            });
            
            // Ejecutar al cargar la página
            actualizarEstado();
            
            // Manejar íconos de flecha en secciones colapsables
            $('.card-header[data-toggle="collapse"]').on('click', function() {
                var target = $(this).data('target');
                var icon = $(this).find('.fa-chevron-down, .fa-chevron-up');
                
                // Cambiar ícono después de un pequeño delay para que coincida con la animación
                setTimeout(function() {
                    if ($(target).hasClass('show')) {
                        icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                    } else {
                        icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                    }
                }, 150);
            });
            
            // Cargar municipios según departamento seleccionado
            $('#Factura_Receptor_CodigoDepartamento').on('change', function() {
                var departamento = $(this).val();
                var municipioSelect = $('#Factura_Receptor_CodigoMunicipio');
                
                // Limpiar municipios
                municipioSelect.empty();
                municipioSelect.append('<option value="">Seleccione municipio...</option>');
                
                if (departamento) {
                    // Cargar municipios según el departamento
                    var municipios = obtenerMunicipiosPorDepartamento(departamento);
                    municipios.forEach(function(municipio) {
                        municipioSelect.append('<option value="' + municipio.codigo + '">' + municipio.codigo + ' - ' + municipio.nombre + '</option>');
                    });
                }
            });
            
            // Función para restaurar el municipio seleccionado
            function restaurarMunicipioSeleccionado() {
                var departamento = $('#Factura_Receptor_CodigoDepartamento').val();
                var municipioSeleccionado = $('#Factura_Receptor_CodigoMunicipio').val();
                
                // Si no hay municipio seleccionado en el campo, intentar obtenerlo del sessionStorage
                if (!municipioSeleccionado) {
                    municipioSeleccionado = sessionStorage.getItem('municipioSeleccionado');
                }
                
                if (departamento && municipioSeleccionado) {
                    // Cargar municipios del departamento
                    var municipioSelect = $('#Factura_Receptor_CodigoMunicipio');
                    municipioSelect.empty();
                    municipioSelect.append('<option value="">Seleccione municipio...</option>');
                    
                    var municipios = obtenerMunicipiosPorDepartamento(departamento);
                    municipios.forEach(function(municipio) {
                        var option = '<option value="' + municipio.codigo + '">' + municipio.codigo + ' - ' + municipio.nombre + '</option>';
                        municipioSelect.append(option);
                    });
                    
                    // Seleccionar el municipio que estaba guardado con un pequeño delay
                    setTimeout(function() {
                        municipioSelect.val(municipioSeleccionado);
                        // Limpiar el sessionStorage después de restaurar
                        sessionStorage.removeItem('municipioSeleccionado');
                    }, 50);
                }
            }
            
            // Función para obtener municipios por departamento (definida globalmente)
            function obtenerMunicipiosPorDepartamento(departamento) {
                var municipios = [];
                
                switch(departamento) {
                    case '00': // Extranjero
                        municipios.push({ codigo: '00', nombre: 'Extranjero' });
                        break;
                    case '01': // Ahuachapán
                        municipios.push(
                            { codigo: '13', nombre: 'AHUACHAPAN NORTE' },
                            { codigo: '14', nombre: 'AHUACHAPAN CENTRO' },
                            { codigo: '15', nombre: 'AHUACHAPAN SUR' }
                        );
                        break;
                    case '02': // Santa Ana
                        municipios.push(
                            { codigo: '14', nombre: 'SANTA ANA NORTE' },
                            { codigo: '15', nombre: 'SANTA ANA CENTRO' },
                            { codigo: '16', nombre: 'SANTA ANA ESTE' },
                            { codigo: '17', nombre: 'SANTA ANA OESTE' }
                        );
                        break;
                    case '03': // Sonsonate
                        municipios.push(
                            { codigo: '17', nombre: 'SONSONATE NORTE' },
                            { codigo: '18', nombre: 'SONSONATE CENTRO' },
                            { codigo: '19', nombre: 'SONSONATE ESTE' },
                            { codigo: '20', nombre: 'SONSONATE OESTE' }
                        );
                        break;
                    case '04': // Chalatenango
                        municipios.push(
                            { codigo: '34', nombre: 'CHALATENANGO NORTE' },
                            { codigo: '35', nombre: 'CHALATENANGO CENTRO' },
                            { codigo: '36', nombre: 'CHALATENANGO SUR' }
                        );
                        break;
                    case '05': // La Libertad
                        municipios.push(
                            { codigo: '23', nombre: 'LA LIBERTAD NORTE' },
                            { codigo: '24', nombre: 'LA LIBERTAD CENTRO' },
                            { codigo: '25', nombre: 'LA LIBERTAD OESTE' },
                            { codigo: '26', nombre: 'LA LIBERTAD ESTE' },
                            { codigo: '27', nombre: 'LA LIBERTAD COSTA' },
                            { codigo: '28', nombre: 'LA LIBERTAD SUR' }
                        );
                        break;
                    case '06': // San Salvador
                        municipios.push(
                            { codigo: '20', nombre: 'SAN SALVADOR NORTE' },
                            { codigo: '21', nombre: 'SAN SALVADOR OESTE' },
                            { codigo: '22', nombre: 'SAN SALVADOR ESTE' },
                            { codigo: '23', nombre: 'SAN SALVADOR CENTRO' },
                            { codigo: '24', nombre: 'SAN SALVADOR SUR' }
                        );
                        break;
                    case '07': // Cuscatlán
                        municipios.push(
                            { codigo: '17', nombre: 'CUSCATLAN NORTE' },
                            { codigo: '18', nombre: 'CUSCATLAN SUR' }
                        );
                        break;
                    case '08': // La Paz
                        municipios.push(
                            { codigo: '23', nombre: 'LA PAZ OESTE' },
                            { codigo: '24', nombre: 'LA PAZ CENTRO' },
                            { codigo: '25', nombre: 'LA PAZ ESTE' }
                        );
                        break;
                    case '09': // Cabañas
                        municipios.push(
                            { codigo: '10', nombre: 'CABAÑAS OESTE' },
                            { codigo: '11', nombre: 'CABAÑAS ESTE' }
                        );
                        break;
                    case '10': // San Vicente
                        municipios.push(
                            { codigo: '14', nombre: 'SAN VICENTE NORTE' },
                            { codigo: '15', nombre: 'SAN VICENTE SUR' }
                        );
                        break;
                    case '11': // Usulután
                        municipios.push(
                            { codigo: '24', nombre: 'USULUTAN NORTE' },
                            { codigo: '25', nombre: 'USULUTAN ESTE' },
                            { codigo: '26', nombre: 'USULUTAN OESTE' }
                        );
                        break;
                    case '12': // San Miguel
                        municipios.push(
                            { codigo: '21', nombre: 'SAN MIGUEL NORTE' },
                            { codigo: '22', nombre: 'SAN MIGUEL CENTRO' },
                            { codigo: '23', nombre: 'SAN MIGUEL OESTE' }
                        );
                        break;
                    case '13': // Morazán
                        municipios.push(
                            { codigo: '27', nombre: 'MORAZAN NORTE' },
                            { codigo: '28', nombre: 'MORAZAN SUR' }
                        );
                        break;
                    case '14': // La Unión
                        municipios.push(
                            { codigo: '19', nombre: 'LA UNION NORTE' },
                            { codigo: '20', nombre: 'LA UNION SUR' }
                        );
                        break;
                }
                
                return municipios;
            }
            
            // Recalcular totales cuando se agregue o elimine un producto
            function recalcularTotalesDespuesDeCambio() {
                var tipoDoc = $('#tipoDocumentoSelect').val();
                var conIVA = tipoDoc === '02';
                recalcularTotales(conIVA);
                
                // Restaurar municipio después de cambios en productos
                setTimeout(function() {
                    restaurarMunicipioSeleccionado();
                }, 100);
            }
            
            // Observar cambios en la tabla de productos (para cuando se agreguen/eliminen productos)
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        setTimeout(recalcularTotalesDespuesDeCambio, 100);
                    }
                });
            });
            
            // Observar la tabla de productos
            var tablaProductos = document.querySelector('.table tbody');
            if (tablaProductos) {
                observer.observe(tablaProductos, { childList: true, subtree: true });
            }
        });

        // Validación básica del formulario
        $('form').on('submit', function(e) {
            var handler = $(e.target).attr('formaction') || $(e.target).closest('button').attr('formaction');
            
            if (handler && handler.includes('AgregarProducto')) {
                // Verificar que se haya seleccionado un tipo de documento
                var tipoDoc = $('#tipoDocumentoSelect').val();
                if (!tipoDoc) {
                    e.preventDefault();
                    alert('Por favor seleccione un tipo de documento antes de agregar productos.');
                    $('#tipoDocumentoSelect').focus();
                    return false;
                }
                
                // Verificar código de país para donaciones
                if (tipoDoc === '15') {
                    var codigoPais = $('#Factura_CodigoPais').val();
                    if (!codigoPais) {
                        e.preventDefault();
                        alert('Por favor seleccione un código de país para documentos de donación.');
                        $('#Factura_CodigoPais').focus();
                        return false;
                    }
                }
                
                var codigo = $('#Factura_CodigoProducto').val();
                var descripcion = $('#Factura_DescripcionProducto').val();
                var cantidad = $('#Factura_CantidadProducto').val();
                var precio = $('#Factura_PrecioProducto').val();
                
                if (!codigo || !descripcion || !cantidad || cantidad <= 0 || !precio || precio <= 0) {
                    e.preventDefault();
                    alert('Por favor complete todos los campos del producto con valores válidos.');
                    return false;
                }
                
                // Limpiar campos después de agregar producto exitosamente
                setTimeout(function() {
                    $('#Factura_CodigoProducto').val('');
                    $('#Factura_DescripcionProducto').val('');
                    $('#Factura_CantidadProducto').val('');
                    $('#Factura_PrecioProducto').val('');
                    $('#Factura_ProductoExento').prop('checked', false);
                    $('#Factura_CodigoProducto').focus();
                }, 100);
            }
            
            if (handler && handler.includes('ProcesarFactura')) {
                var tipoDoc = $('#tipoDocumentoSelect').val();
                if (!tipoDoc) {
                    e.preventDefault();
                    alert('Por favor seleccione el tipo de documento.');
                    return false;
                }
            }
        });

        // Función para abrir la clasificación del BCR
        function abrirClasificacionBCR() {
            var url = 'https://onec.bcr.gob.sv/clasificadoresv2/Clasificadores/Index/200?tipo=1';
            var ventana = window.open(url, 'ClasificacionBCR', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            // Mostrar mensaje informativo
            if (ventana) {
                alert('Se ha abierto la clasificación del BCR en una nueva ventana.\n\nPara usar la información:\n1. Busque la actividad económica del receptor\n2. Copie el código y descripción\n3. Cierre la ventana y regrese aquí\n4. Complete los campos de Giro y Código de Actividad Económica del receptor\n\nNota: Estos campos solo son necesarios para Crédito Fiscal.');
            } else {
                alert('No se pudo abrir la ventana. Por favor, habilite los popups para este sitio.');
            }
        }


        // Prevenir doble clic y mostrar ventana de espera para Procesar Factura
        $(document).on('click', 'button[asp-page-handler="ProcesarFactura"]', function(e) {
            var submitButton = $(this);
            
            // Si ya está procesando, prevenir clic
            if (submitButton.hasClass('processing')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Marcar como procesando
            submitButton.addClass('processing');
            submitButton.prop('disabled', true);
            submitButton.html('<i class="fas fa-hourglass-split me-2"></i>Procesando Factura...');
            
            // Mostrar overlay de carga
            showLoadingOverlay();
            
            // Permitir el envío del formulario
            return true;
        });

        // Función para mostrar overlay de carga
        function showLoadingOverlay() {
            // Crear overlay si no existe
            if ($('#loadingOverlay').length === 0) {
                $('body').append(`
                    <div id="loadingOverlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 9999;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        backdrop-filter: blur(3px);
                    ">
                        <div style="
                            background: white;
                            padding: 2rem;
                            border-radius: 12px;
                            text-align: center;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                            max-width: 400px;
                            width: 90%;
                        ">
                            <div style="
                                width: 60px;
                                height: 60px;
                                border: 4px solid #e3e3e3;
                                border-top: 4px solid #007bff;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 1rem;
                            "></div>
                            <h4 style="color: #007bff; margin-bottom: 0.5rem; font-weight: 600;">
                                <i class="fas fa-gear-fill me-2"></i>Procesando Factura
                            </h4>
                            <p style="color: #6c757d; margin: 0; font-size: 0.9rem;">
                                Generando documento tributario electrónico...
                            </p>
                            <p style="color: #dc3545; margin: 0.5rem 0 0 0; font-size: 0.8rem; font-weight: 500;">
                                <i class="fas fa-exclamation-triangle me-1"></i>No cierre esta ventana
                            </p>
                        </div>
                    </div>
                `);
                
                // Agregar estilos CSS para la animación
                $('head').append(`
                    <style>
                        @@keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `);
            } else {
                $('#loadingOverlay').show();
            }
        }
    </script>
}

@section Styles {
    <style>
        .card-outline {
            border-top: 3px solid;
        }
        
        .form-check-input {
            margin-top: 0.5rem;
        }
        
        .table th {
            background-color: #f8f9fa;
        }
        
        .badge {
            font-size: 0.8em;
        }
        
        /* Mejorar legibilidad de badges */
        .badge-secondary {
            background-color: #6c757d !important;
            color: white !important;
            font-weight: 600;
        }
        
        .badge-primary {
            background-color: #007bff !important;
            color: white !important;
            font-weight: 600;
        }
        
        /* Alternativa con colores más contrastantes */
        .badge-exento {
            background-color: #28a745 !important;
            color: white !important;
            font-weight: 600;
        }
        
        .badge-gravado {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: 600;
        }
        
        /* Transiciones suaves para mejor experiencia de usuario */
        html {
            scroll-behavior: smooth;
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .table {
            transition: opacity 0.3s ease;
        }
        
        /* Prevenir saltos bruscos en el scroll */
        body {
            scroll-padding-top: 20px;
        }
        
        /* Estilos para secciones colapsables */
        .card-header[data-toggle="collapse"] {
            transition: background-color 0.3s ease;
        }
        
        .card-header[data-toggle="collapse"]:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .card-header[data-toggle="collapse"] .card-title {
            margin-bottom: 0;
            user-select: none;
        }
        
        .card-header[data-toggle="collapse"] .fa-chevron-down,
        .card-header[data-toggle="collapse"] .fa-chevron-up {
            transition: transform 0.3s ease;
        }
        
        .card-header[data-toggle="collapse"] .fa-chevron-up {
            transform: rotate(180deg);
        }
        
        /* Animación suave para el collapse */
        .collapse {
            transition: all 0.3s ease;
        }
        
        /* Estilos para campos de crédito fiscal */
        .campos-credito-fiscal {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #17a2b8;
            transition: all 0.3s ease-in-out;
            opacity: 1;
        }
        
        .campos-credito-fiscal[style*="display: none"] {
            opacity: 0;
        }
        
        .campos-credito-fiscal .form-group {
            margin-bottom: 10px;
        }
        
        .campos-credito-fiscal label {
            font-weight: 600;
            color: #495057;
        }
        
        .campos-credito-fiscal .text-muted {
            margin-top: 10px;
            display: block;
        }
        
        .campos-credito-fiscal hr {
            border-color: #dee2e6;
            margin: 15px 0;
        }
        
        /* Estilo para el botón de búsqueda */
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            transition: all 0.3s ease;
        }
        
        .btn-info:hover {
            background-color: #138496;
            border-color: #117a8b;
            transform: translateY(-1px);
        }
        
        /* Eliminar el indicador visual anterior ya que ahora está integrado */
        .campos-credito-fiscal::before {
            display: none;
        }
        
        /* Estilo para el placeholder de los campos */
        .campos-credito-fiscal input::placeholder {
            color: #6c757d;
            font-style: italic;
        }
        
        /* Hover effect para el área de crédito fiscal */
        .campos-credito-fiscal:hover {
            background-color: #e9ecef;
            border-left-color: #138496;
        }
        
        /* Estilo para el ícono de información */
        .campos-credito-fiscal .fa-info-circle {
            color: #17a2b8;
        }
        
        /* Estilos para la alerta del tipo de documento */
        #alertaTipoDocumento .alert {
            border-left: 4px solid #ffc107;
            background-color: #fff3cd;
            color: #856404;
            margin-bottom: 0;
        }
        
        #alertaTipoDocumento .alert .fa-exclamation-triangle {
            color: #ffc107;
            margin-right: 8px;
        }
        
        #alertaTipoDocumento .alert strong {
            color: #856404;
        }
        
        #alertaTipoDocumento .alert .close {
            color: #856404;
            opacity: 0.7;
        }
        
        #alertaTipoDocumento .alert .close:hover {
            opacity: 1;
        }
        
        /* Animación para la alerta */
        #alertaTipoDocumento .alert {
            animation: fadeInDown 0.5s ease-in-out;
        }
        
        @@keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Estilo para el select del tipo de documento cuando no hay selección */
        #tipoDocumentoSelect:invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }
        
        /* Estilo para enfatizar la importancia del tipo de documento */
        .card-warning.card-outline {
            border-top-color: #ffc107 !important;
        }
        
        .card-warning.card-outline .card-body {
            background-color: #fff8e1;
        }
    </style>
}
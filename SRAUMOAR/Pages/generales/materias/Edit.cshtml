@page
@model SRAUMOAR.Pages.generales.materias.EditModel

@{
    ViewData["Title"] = "Editar";
}

<!DOCTYPE html>
<html lang="es">
<body>
    <header class="bg-primary text-white text-center py-3 mb-4">
        <h1>Edición Materia</h1>
    </header>
    <hr />
    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-dark text-white text-center">
                <h4 class="fs-4 fw-semibold text-white formal-text">Materia</h4>
            </div>
            <div class="container mt-1">
                <div class="row justify-content-center">
                    <div class="col-md-5">
                        <div class="card-body">
                            <form method="post">
                                <div asp-validation-summary="ModelOnly" class="alert alert-danger d-flex align-items-center" role="alert"></div>
                                <input type="hidden" asp-for="Materia.MateriaId" />
                                <div class="mb-3">
                                    <label asp-for="Materia.NombreMateria" class="form-label fs-4 fw-semibold text-dark formal-text">Nombre de la Materia</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-journal"></i></span>
                                        <input asp-for="Materia.NombreMateria" class="form-control" placeholder="Ingrese el nombre de la Materia" />
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.NombreMateria" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Materia.CodigoMateria" class="form-label fs-4 fw-semibold text-dark formal-text">Codigo de la Materia</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-journal"></i></span>
                                        <input asp-for="Materia.CodigoMateria" class="form-control" placeholder="Ingrese codigo de la Carrera" />
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.CodigoMateria" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Materia.Ciclo" class="form-label fs-4 fw-semibold text-dark formal-text">Ciclo</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-journal"></i></span>
                                        <input asp-for="Materia.Ciclo" class="form-control" placeholder="Ingrese el ciclo" />
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.Ciclo" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Materia.Correlativo" class="form-label fs-4 fw-semibold text-dark formal-text">Correlativo</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-journal"></i></span>
                                        <input asp-for="Materia.Correlativo" class="form-control" placeholder="Ingrese Correlativo" />
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.Correlativo" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Materia.uv" class="form-label fs-4 fw-semibold text-dark formal-text">UV</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-journal"></i></span>
                                        <input asp-for="Materia.uv" class="form-control" placeholder="Unidades Valorativas" />
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.uv" class="text-danger"></span>
                                </div>
                                <div class="mb-3">
                                    <label asp-for="Materia.PensumId" class="form-label fs-4 fw-semibold text-dark formal-text">Pensum</label>
                                    <br>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-mortarboard"></i></span>
                                        <select asp-for="Materia.PensumId" class="form-control" asp-items="ViewBag.PensumId"></select>
                                    </div>
                                    <br>
                                    <span asp-validation-for="Materia.PensumId" class="text-danger"></span>
                                </div>
                                <div class="form-group form-check">
                                    <label class="form-check-label">
                                        <input class="form-check-input" asp-for="Materia.RequisitoBachillerato" /> @Html.DisplayNameFor(model => model.Materia.RequisitoBachillerato)
                                    </label>
                                </div>

                                <!-- Sección de Prerrequisitos -->
                                <div class="mb-3" id="seccionPrerrequisitos">
                                    <label class="form-label fs-4 fw-semibold text-dark formal-text">
                                        <i class="bi bi-link-45deg me-2"></i> Prerrequisitos de la Materia
                                    </label>
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <p class="text-muted mb-3">
                                                <i class="bi bi-info-circle me-2"></i>
                                                Seleccione las materias que deben ser aprobadas antes de cursar esta materia:
                                            </p>
                                            <div id="listaPrerrequisitos" class="row">
                                                <!-- Los prerrequisitos se cargarán dinámicamente aquí -->
                                            </div>
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-outline-success btn-sm" id="agregarPrerrequisito">
                                                    <i class="bi bi-plus-circle me-2"></i> Agregar Otro Prerrequisito
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <br>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                                    </button>
                                </div>
                                <br>
                            </form>
                        </div>
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-3">
        <a asp-page="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a la lista
        </a>
    </div>
    @section Scripts {
        @{
            await Html.RenderPartialAsync("_ValidationScriptsPartial");
        }
        <script>
            // Funcionalidad para prerrequisitos en edición
            let contadorPrerrequisitos = 0;
            let materiasDisponibles = [];
            let prerrequisitosExistentes = @Html.Raw(Json.Serialize(Model.PrerrequisitosExistentes));

            // Cargar materias cuando se carga la página
            document.addEventListener('DOMContentLoaded', function() {
                const pensumId = document.querySelector('select[name="Materia.PensumId"]').value;
                if (pensumId) {
                    cargarMateriasDelPensum(pensumId);
                }
            });

            // Cargar materias del pensum seleccionado
            async function cargarMateriasDelPensum(pensumId) {
                try {
                    const materiaActualId = @Model.Materia.MateriaId;
                    const response = await fetch(`?handler=MateriasDelPensum&pensumId=${pensumId}&materiaActualId=${materiaActualId}`);
                    if (response.ok) {
                        materiasDisponibles = await response.json();
                        cargarPrerrequisitosExistentes();
                    }
                } catch (error) {
                    console.error('Error al cargar materias:', error);
                }
            }

            // Cargar prerrequisitos existentes
            function cargarPrerrequisitosExistentes() {
                const container = document.getElementById('listaPrerrequisitos');
                container.innerHTML = '';

                if (prerrequisitosExistentes && prerrequisitosExistentes.length > 0) {
                    prerrequisitosExistentes.forEach((prerrequisito, index) => {
                        agregarPrerrequisito(prerrequisito.prerrequisoMateriaId);
                    });
                } else {
                    // Agregar un prerrequisito vacío si no hay existentes
                    agregarPrerrequisito();
                }
            }

            // Agregar un nuevo prerrequisito
            function agregarPrerrequisito(prerrequisitoIdSeleccionado = null) {
                const container = document.getElementById('listaPrerrequisitos');
                const prerrequisitoDiv = document.createElement('div');
                prerrequisitoDiv.className = 'col-md-6 mb-3';
                prerrequisitoDiv.id = `prerrequisito-${contadorPrerrequisitos}`;

                let options = '<option value="">Seleccione una materia</option>';
                materiasDisponibles.forEach(materia => {
                    const selected = prerrequisitoIdSeleccionado === materia.materiaId ? 'selected' : '';
                    options += `<option value="${materia.materiaId}" ${selected}>${materia.nombre}</option>`;
                });

                prerrequisitoDiv.innerHTML = `
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-link-45deg"></i>
                        </span>
                        <select name="PrerrequisitosSeleccionados" class="form-control prerrequisito-select">
                            ${options}
                        </select>
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarPrerrequisito(${contadorPrerrequisitos})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;

                container.appendChild(prerrequisitoDiv);
                contadorPrerrequisitos++;
            }

            // Eliminar un prerrequisito
            function eliminarPrerrequisito(index) {
                const prerrequisitoDiv = document.getElementById(`prerrequisito-${index}`);
                if (prerrequisitoDiv) {
                    prerrequisitoDiv.remove();
                }
            }

            // Agregar prerrequisito cuando se hace clic en el botón
            document.getElementById('agregarPrerrequisito').addEventListener('click', function() {
                agregarPrerrequisito();
            });
        </script>
    }
</body>
</html>

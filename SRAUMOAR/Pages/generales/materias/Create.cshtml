@page
@model SRAUMOAR.Pages.generales.materias.CreateModel

@{
    ViewData["Title"] = "Nueva Materia";
}

<div class="gm-shell">
    <div class="gm-hero">
        <div>
            <p class="gm-eyebrow">Gestión Académica</p>
            <h1 class="gm-title">Nueva Materia</h1>
            <p class="gm-subtitle">Complete la información base y los prerrequisitos.</p>
        </div>
        <a asp-page="./Materias" asp-route-id="@Model.Materia?.PensumId" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Volver
        </a>
    </div>

    <div class="gm-form-card">
        <form method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Materia.NombreMateria" class="form-label"></label>
                    <input asp-for="Materia.NombreMateria" class="form-control" placeholder="Ej. Matemática I" />
                    <span asp-validation-for="Materia.NombreMateria" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Materia.CodigoMateria" class="form-label"></label>
                    <input asp-for="Materia.CodigoMateria" class="form-control" placeholder="Ej. MAT101" />
                    <span asp-validation-for="Materia.CodigoMateria" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="Materia.Ciclo" class="form-label"></label>
                    <input asp-for="Materia.Ciclo" class="form-control" />
                    <span asp-validation-for="Materia.Ciclo" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Materia.Correlativo" class="form-label"></label>
                    <input asp-for="Materia.Correlativo" class="form-control" />
                    <span asp-validation-for="Materia.Correlativo" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Materia.uv" class="form-label"></label>
                    <input asp-for="Materia.uv" class="form-control" />
                    <span asp-validation-for="Materia.uv" class="text-danger"></span>
                </div>

                <div class="col-md-8">
                    <label asp-for="Materia.PensumId" class="form-label"></label>
                    <select asp-for="Materia.PensumId" class="form-select" asp-items="ViewBag.PensumId" id="pensumSelect">
                        <option value="">Seleccione un pensum</option>
                    </select>
                    <span asp-validation-for="Materia.PensumId" class="text-danger"></span>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <div class="form-check form-switch pb-2">
                        <input class="form-check-input" type="checkbox" id="requisitoBachillerato" asp-for="Materia.RequisitoBachillerato">
                        <label class="form-check-label" for="requisitoBachillerato">
                            @Html.DisplayNameFor(model => model.Materia.RequisitoBachillerato)
                        </label>
                    </div>
                </div>
            </div>

            <div class="gm-subpanel mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-link-45deg me-1"></i> Prerrequisitos</h5>
                    <button type="button" class="btn btn-outline-success btn-sm" id="agregarPrerrequisito">
                        <i class="bi bi-plus-circle me-1"></i> Agregar
                    </button>
                </div>
                <div id="listaPrerrequisitos" class="row g-2">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">Seleccione un pensum para cargar materias disponibles.</div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-page="./Materias" asp-route-id="@Model.Materia?.PensumId" class="btn btn-outline-secondary">
                    Cancelar
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle me-1"></i> Crear materia
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let contadorPrerrequisitos = 0;
        let materiasDisponibles = [];

        document.addEventListener('DOMContentLoaded', function () {
            const pensumSelect = document.getElementById('pensumSelect');
            if (!pensumSelect) return;

            pensumSelect.addEventListener('change', function () {
                const pensumId = this.value;
                if (pensumId) {
                    cargarMateriasDelPensum(pensumId);
                } else {
                    renderInfoPrerrequisitos('Seleccione un pensum para cargar materias disponibles.');
                    contadorPrerrequisitos = 0;
                }
            });
        });

        async function cargarMateriasDelPensum(pensumId) {
            try {
                const response = await fetch(`?handler=MateriasDelPensum&pensumId=${pensumId}`);
                if (!response.ok) throw new Error('No se pudieron cargar las materias.');

                materiasDisponibles = await response.json();
                const container = document.getElementById('listaPrerrequisitos');
                container.innerHTML = '';
                contadorPrerrequisitos = 0;

                if (materiasDisponibles.length === 0) {
                    renderInfoPrerrequisitos('Este pensum no tiene materias para usar como prerrequisito.');
                    return;
                }

                agregarPrerrequisito();
            } catch {
                renderInfoPrerrequisitos('Error al cargar las materias del pensum.', true);
            }
        }

        function renderInfoPrerrequisitos(mensaje, esError = false) {
            const container = document.getElementById('listaPrerrequisitos');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert ${esError ? 'alert-danger' : 'alert-info'} mb-0">${mensaje}</div>
                </div>
            `;
        }

        function agregarPrerrequisito() {
            if (materiasDisponibles.length === 0) return;

            const container = document.getElementById('listaPrerrequisitos');
            const prerrequisitoDiv = document.createElement('div');
            prerrequisitoDiv.className = 'col-md-6';
            prerrequisitoDiv.id = `prerrequisito-${contadorPrerrequisitos}`;

            prerrequisitoDiv.innerHTML = `
                <div class="input-group">
                    <select name="PrerrequisitosSeleccionados" class="form-select">
                        <option value="">Seleccione una materia</option>
                        ${materiasDisponibles.map(m => `<option value="${m.materiaId}">${m.nombre}</option>`).join('')}
                    </select>
                    <button type="button" class="btn btn-outline-danger" onclick="eliminarPrerrequisito(${contadorPrerrequisitos})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            container.appendChild(prerrequisitoDiv);
            contadorPrerrequisitos++;
        }

        function eliminarPrerrequisito(index) {
            const item = document.getElementById(`prerrequisito-${index}`);
            if (item) item.remove();
        }

        document.getElementById('agregarPrerrequisito').addEventListener('click', agregarPrerrequisito);
    </script>
}